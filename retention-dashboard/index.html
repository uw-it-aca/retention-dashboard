<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Retention Dashboard</title>
  <link rel="icon" href="static/img/favicon.png">

  <link type="text/css" rel="stylesheet" href="style.css" />

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />

  <!-- Load polyfills to support older browsers -->
  <script src="http://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>

  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

  <!-- Load the following for BootstrapVueIcons support -->
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

  <!-- Load VueX -->
  <script src="https://unpkg.com/vuex"></script>

  <!--  Load Axios-->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <!-- Load PapaParse CSV parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>

  <!-- Load Clipboard.js -->
  <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>

  <script type="text/x-template" id="default-template">
    <b-container fluid>
      <b-row class="rd-app-banner">
        <b-col cols="3" sm="9" lg="10">
          <h1 class="rd-app-title"><span class="hide-lg">Retention Analytics Dashboard</span></h1>
        </b-col>
        <b-col>
          <h2 id="rd_login_header" class="sr-only">Your information</h2>
          <div aria-labelledby="rd_login_header" class="rd-login-info">
            <div>Welcome, </span><span id="netid">{{ netid }}</span></div>
            <a href="/saml/logout" tabindex="0" class="rd-logout-link">Sign out</a>
          </div>
        </b-col>
      </b-row>
      <b-row>
        <filedisplay />
      </b-row>
      <b-row>
        <footer class="rd-footer" role="contentinfo">
          <a href="http://www.uw.edu" class="rd-footer-wordmark">University of Washington</a>
          <div class="rd-footer-links">
            <a href="https://www.washington.edu/online/privacy/">Privacy</a> / <a href="https://www.washington.edu/online/terms/">Terms</a>
          </div>
          <div>© 2019 University of Washington  |  Seattle, WA</div>
        </footer>
      </b-row>
    </b-container>
  </script>

  <script type="text/x-template" id="leftnav-template">
    <div>
      <b-nav pills>
        <b-nav-item-dropdown
          id="file-dropdown"
          :text="'File:' + ' ' + filename"
          toggle-class="nav-link-custom"
          right
        >
          <b-dropdown-item href="#" @click.prevent="selectPage('one.csv')">File: one.csv</b-dropdown-item>
          <b-dropdown-item href="#" @click.prevent="selectPage('two.csv')">File: two.csv</b-dropdown-item>
          <b-dropdown-item href="#" @click.prevent="selectPage('three.csv')">File: three.csv</b-dropdown-item>
        </b-nav-item-dropdown>
      </b-nav>
    </div>
  </script>

  <script type="text/x-template" id="filedisplay-template">
    <b-container fluid>
      <p>Students Selected: {{ selected_count }}</p>
      <div>
        <b-button v-b-modal.email-modal>Get E-Mail Addresses</b-button>
        <b-modal id="email-modal" title="E-Mail Addresses" ok-only>
          <textarea id="email_area" readonly>{{ email_list_text }}</textarea>
          <button class="copybtn" data-clipboard-target="#email_area">copy</button>
        </b-modal>
        <button id="csv_download" @click="download_filtered">Download Filtered CSV</button></div>
      <span class="rd-file-select"><leftnav /></span>
      <b-pagination
              v-model="currentPage"
              :total-rows="rows"
              :per-page="perPage"
              aria-controls="data-table"
      ></b-pagination>
      <b-table
              id="data-table"
              :items="items"
              :fields="fields"
              :per-page= "perPage"
              :current-page="currentPage"
      >


        <template v-slot:cell(actions)="row">
          <b-form-group>
            <b-form-checkbox
                    :id="'email_select' + row.item.email"
                    :key="row.item.email"
                    v-model="selected[row.item.email]"
                    :name="'email_select' + row.item.email"
                    :value="true"
                    :unchecked-value="false"
            >
              <span class="sr-only">Select application {{ row.item.admission_selection_id }}</span>
            </b-form-checkbox>
          </b-form-group>
        </template>
      </b-table>
    </b-container>
  </script>

</head>
<body>
  <div id="app" class="rd-content-container">
    <structure></structure>
  </div>

    <script>
      const store = new Vuex.Store({
        state: {
          current_file: ""
        },
        mutations: {
          set_file (state, value){
            state.current_file = value;
          }
        },
        actions: {
          set_file ({ commit, state }, value) {
            commit('set_file', value)
          }
        }
      });

      Vue.component("structure", {
        template: "#default-template",
        data(){
          return {
            netid: '',
          };
        },
        mounted() {
          this.netid = window.user_netid;
        },
        methods: {

        }
      });
      
      Vue.component("leftnav", {
        template: "#leftnav-template",
        data(){
          return {

          };
        },
        computed: {
          filename (){
            return this.$store.state.current_file;
          }
        },
        mounted() {

        },
        methods: {
          selectPage(page){
            this.$store.dispatch('set_file', page);
          }
        }
      });

      Vue.component("filedisplay", {
        template: "#filedisplay-template",
        data: function() {
          return {
            fields: [
              {
                key: 'Actions',
                label: '✓'
              },
              {
                key: 'student_name',
                label: "Student Name",
                sortable: true
              },
              {
                key: 'email',
                label: 'Email',
              },
              {
                key: 'netid',
                label: 'UWNetid',
              },
              {
                key: 'pre-major',
                label: 'Pre-Major Status',
                sortable: true
              },
              {
                key: 'activity_score',
                label: 'Activity Score',
                sortable: true
              },
              {
                key: 'assignments',
                label: 'Assignments',
                sortable: true
              },
              {
                key: 'grades',
                label: 'Grades',
                sortable: true
              }
            ],
            items: [],
            csv_data: "",
            perPage: 10,
            currentPage: 1,
            selected: {}
          }
        },
        computed: {
          filename (){
            return this.$store.state.current_file;
          },
          rows (){
            return this.items.length;
          },
          selected_count (){
            return this.get_selected().length;
          },
          email_list_text () {
            var selected = this.get_selected();
            return selected.join(", ");;
          }
        },
        methods: {
          get_selected(){
            var selected = [];
            for (var key in this.selected) {
              if (this.selected.hasOwnProperty(key)) {
                if(this.selected[key] === true){
                  selected.push(key);
                }
              }
            }
            return selected;
          },
          load_file(filename){
            var vue = this;
            axios.get('/data/' + filename)
              .then(function(response){
                vue.csv_data = response.data;
              })
            .catch(function (error) {
              console.log(error)
            })
          },
          download_filtered() {
            var to_download = [],
                    hiddenElement = document.createElement('a'),
                    selected = this.get_selected(),
                    timestamp = Math.round(Date.now()/1000),
                    csv_string = "";
            for (var item in this.items){
              if(selected.includes(this.items[item]['email'])){
                to_download.push(this.items[item])
              }
            }
            // format object to string

            // Header
            var fields = Object.keys(to_download[0]);
            csv_string += fields.join(",");
            csv_string += "\n";

            // Data
            to_download.forEach(function(item){

              var row_string = "";
              fields.forEach(function(field){
                row_string += item[field] + ","
              });
              //remove trailing comma
              csv_string += row_string.slice(0, -1) + "\n"
            });

            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv_string);
            hiddenElement.target = '_blank';
            hiddenElement.download = 'rentention_export_'+timestamp+'.csv';
            hiddenElement.click();
          }
        },
        mounted: function(){
          this.$store.watch(
                  state => state.current_file,
                  (file) => {
                    this.load_file(file)
                  }
          )
          this.$store.dispatch('set_file', "one.csv");
          new ClipboardJS('.copybtn');
        },
        watch: {
          csv_data: function (csv){
            var parsed_csv = Papa.parse(csv, {header: true});
            this.items = parsed_csv.data;
          }
        }
      });

      var app = new Vue({
        el: '#app',
        store
      })
    </script>
  </body>
</html>