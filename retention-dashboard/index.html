<!DOCTYPE html>
<html>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<head>
  <title>Retention Dashboard</title>
  <link rel="stylesheet" type="text/css" href="/style.css" />

  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />

  <!-- Load polyfills to support older browsers -->
  <script src="http://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>

  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

  <!-- Load the following for BootstrapVueIcons support -->
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

  <!-- Load VueX -->
  <script src="https://unpkg.com/vuex"></script>

  <!--  Load Axios-->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <!-- Load PapaParse CSV parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>


  <script type="text/x-template" id="leftnav-template">
    <ul>
      <li><a href="#" @click.prevent="selectPage('one.csv')">File one</a></li>
      <li><a href="#" @click.prevent="selectPage('two.csv')">File two</a></li>
      <li><a href="#" @click.prevent="selectPage('three.csv')">File three</a></li>
    </ul>
  </script>
  <script type="text/x-template" id="filedisplay-template">
    <div>
      <h1>Display of {{ filename }}</h1>
      <b-table :items="items" :fields="fields"></b-table>
    </div>
  </script>
</head>
<body>
<div id="app">
  <leftnav></leftnav>
  <hr />
  <filedisplay></filedisplay>

</div>

<script>
  const store = new Vuex.Store({
    state: {
      current_file: ""
    },
    mutations: {
      set_file (state, value){
        state.current_file = value;
      }
    },
    actions: {
      set_file ({ commit, state }, value) {
        commit('set_file', value)
      }
    }
  });

  Vue.component("leftnav", {
    template: "#leftnav-template",
    mounted() {

    },
    methods: {
      selectPage(page){
        this.$store.dispatch('set_file', page);
      }
    }
  });

  Vue.component("filedisplay", {
    template: "#filedisplay-template",
    data: function() {
      return {
        fields: [
          {
            key: 'has_issue',
            label: "Has retention issue",
            sortable: true
          },
          {
            key: 'score',
            label: 'Retention Score',
            sortable: true
          },
          {
            key: 'comments',
            label: 'Comments'}
        ],
        items: [],
        csv_data: ""
      }
    },
    computed: {
      filename (){
        return this.$store.state.current_file;
      }
    },
    methods: {
      load_file(filename){
        var vue = this;
        axios.get('/data/' + filename)
          .then(function(response){
            vue.csv_data = response.data;
          })
        .catch(function (error) {
          console.log(error)
        })
      }
    },
    mounted: function(){
      this.$store.watch(
              state => state.current_file,
              (file) => {
                this.load_file(file)
              }
      )
      this.$store.dispatch('set_file', "one.csv");
    },
    watch: {
      csv_data: function (csv){
        var parsed_csv = Papa.parse(csv, {header: true});
        this.items = parsed_csv.data;
      }
    }
  });

  var app = new Vue({
    el: '#app',
    store
  })
</script>
</body>
</html>