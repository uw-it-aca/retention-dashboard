<html>
<head>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  {% csrf_token %}
  <script>
    $(document).ready(function() {
      $("#week_form").submit(function (e) {
        e.preventDefault();
        var csrf = jQuery("[name=csrfmiddlewaretoken]").val();
        $.ajax({
          url: "/api/admin/week/",
          method: "POST",
          data: {
            'year': $("#year").val(),
            'quarter': $("#quarter").val(),
            'week': $("#week").val()
          },
          headers: {
            'X-CSRFToken': csrf
          }
        }).done(function (response) {
          if(!response.created){
            alert("Week already exists");
          } else {
            alert("Week created");
            location.reload()
          }
        });
      });

      $("#data_form").submit(function (e) {
        e.preventDefault();
        var csrf = jQuery("[name=csrfmiddlewaretoken]").val(),
                data = new FormData();
        data.append('type', $('input[name=type]:checked', '#data_form').val())
        data.append('week', $("#selected_week").val())
        data.append('file', $('#file').get(0).files[0])

        $.ajax({
          url: "/api/admin/dataset/",
          method: "POST",
          data: data,
          mimeType: 'multipart/form-data',
          contentType: false,
          processData: false,
          dataTyte: 'json',
          headers: {
            'X-CSRFToken': csrf
          }
        }).done(function (response) {
          alert('uploaded')
          location.reload()
        }).fail(function (response){
          if (response.status === 400){
            alert('week and type combo already exists')
          }
        });
      });
      $(".delete").click(function (e) {
        e.preventDefault();
        var upload_id = $(e.target).val(),
                csrf = jQuery("[name=csrfmiddlewaretoken]").val();
        $.ajax({
          url: "/api/admin/dataset/" + upload_id + "/",
          method: "DELETE",
          contentType: false,
          processData: false,
          dataTyte: 'json',
          headers: {
            'X-CSRFToken': csrf
          }
        }).done(function (response) {
          alert('deleted')
          location.reload()
        }).fail(function (response){
        });
      })
      $("#mock_data").click(function (e) {
        e.preventDefault();
        var csrf = jQuery("[name=csrfmiddlewaretoken]").val();

        $.ajax({
          url: "/api/admin/mock_data/",
          method: "PUT",
          dataTyte: 'json',
          headers: {
            'X-CSRFToken': csrf
          }
        }).done(function (response) {
          alert('mock data loaded');
          location.reload()
        }).fail(function (response){
          alert('Issue loading mock data');
        });
      });
    });
  </script>
</head>
<body>
<h1>RAD Data Admin</h1>
<div>
  {% if debug %}
    <h2>Mock Data Admin</h2>
    Click this button to load mock data (available on dev builds only).  Will take approx. 60 seconds to load 2 weeks of data, alert will be generated on success or failure <button id="mock_data">Load Mock Data</button>
  {% endif %}
  <h2>Week Admin</h2>
  <div>
    <h3>Weeks</h3>
    <table border="1">
      <tr><th>Year</th><th>Quarter</th><th>Week</th></tr>
      {% for week in weeks %}
        <tr><td>{{ week.year }}</td><td>{{ week.get_quarter_display }}</td><td>{{ week.number }}</td></tr>

      {% endfor %}
    </table>

  </div>
  <div>
    <h3>Add New Week</h3>
    <p>Adding a new week will make it avalible for a dataset upload, new weeks will not appear in the UI until they have data attached</p>
    <form id="week_form">
      Week Number: <input id="week" minlength="1" maxlength="2">
      Quarter:
      <select id="quarter">
        <option value="4">Autumn</option>
        <option value="1">Winter</option>
        <option value="2">Spring</option>
        <option value="3">Summer</option>
      </select>
      Year: <input id="year" maxlength="4" minlength="4" max="2100">
      <input type="submit" value="Add Week">
    </form>
  </div>
  <div>
    <h2>Data Admin</h2>
  <p>Only one file upload is allowed per type (eg Premajor) and week combination.  Add a new week above if it isn't in the dropdown.</p>
    <form id="data_form">
      <input id="file" type="file">
      <br />
      Premajor: <input type="radio" value="1" name="type">
      <br />
      EOP: <input type="radio" value="2" name="type">
      <br />
      International: <input type="radio" value="3" name="type">
      <br />
      <select id="selected_week">
        {% for week in weeks %}
          <option value="{{ week.id }}">{{ week.year }} - {{ week.get_quarter_display }} - Week {{ week.number }}</option>
        {% endfor %}
      </select>
    <input type="submit" value="Add Dataset">
    </form>
  <div>
    <h3>Existing Uploads</h3>
  <p>Deleting a upload will delete all data associated with it, so this has user facing consequences.  Should only be needed if a file is erroneously uploaded</p>
    <table>
      <tr><th>Date</th><th>User</th><th>Type</th><th>Week</th><th>Delete</th></tr>
      {% for upload in uploads %}
        <tr><td>{{upload.created_on}}</td><td>{{upload.uploaded_by}}</td><td>{{upload.get_type_display}}</td><td>{{ upload.week.year }} - {{ upload.week.get_quarter_display }} - Week {{ upload.week.number }}</td><td><button class="delete" value="{{ upload.id }}">x</button></td></tr>
      {% endfor %}
    </table>
  </div>
  </div>
</div>
</body>
</html>
